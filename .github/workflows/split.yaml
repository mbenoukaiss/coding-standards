name: Split repository

on:
  push:
    branches:
      - master
    tags:
      - 'php-v*'
      - 'js-v*'

permissions:
  contents: write

jobs:
  split-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Parse tags
        id: parse-tags
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # extract language e.g. php-v1.0.0 -> LANG=php, VERSION=v1.0.0
            FULL_TAG="${{ github.ref_name }}"
            echo "lang=${FULL_TAG%%-*}" >> $GITHUB_OUTPUT
            echo "version=${FULL_TAG#*-}" >> $GITHUB_OUTPUT
            echo "mode=tag" >> $GITHUB_OUTPUT
          else
            echo "mode=push" >> $GITHUB_OUTPUT
          fi

      - name: Push PHP folder to pkg/php branch
        if: steps.parse-tags.outputs.mode == 'push' || steps.parse-tags.outputs.lang == 'php'
        uses: s0/git-publish-subdir-action@develop
        env:
          REPO: self
          BRANCH: split/php
          FOLDER: php
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKIP_EMPTY_COMMITS: true
          TAG: ${{ steps.meta.outputs.version }}

      - name: Push JS folder to pkg/js branch
        if: steps.parse-tags.outputs.mode == 'push' || steps.parse-tags.outputs.lang == 'js'
        uses: s0/git-publish-subdir-action@develop
        env:
          REPO: self
          BRANCH: split/js
          FOLDER: js
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKIP_EMPTY_COMMITS: true
          TAG: ${{ steps.meta.outputs.version }}
